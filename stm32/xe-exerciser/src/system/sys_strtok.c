/******************************************************************************\
|* Common library code
|*
|* Module: string tokenizer
|*
\******************************************************************************/

#include "sys_strtok.h"

static char *_sp = NULL;		// Local storage

/******************************************************************************\
|* Tokenize a string
\******************************************************************************/
char * strtok(char *restrict str, const char *restrict delimiters)
	{
	int i 	= 0;
	
	/**************************************************************************\
	|* Sanity check: check the argument
	\**************************************************************************/
	if (!delimiters)
		return NULL; 

	/**************************************************************************\
	|* Sanity check: check the delimiters
	\**************************************************************************/
	int len = strlen(delimiters);
	if(len == 0) 
		return NULL;

	/**************************************************************************\
	|* Sanity check: if the original string has nothing left
	\**************************************************************************/
	if(!str && !_sp)
		return NULL;

	/**************************************************************************\
	|* initialize the sp during the first call
	\**************************************************************************/
	if(str && !_sp)
		_sp = str;

	/**************************************************************************\
	|* find the start of the substring, skip delimiters
	\**************************************************************************/
	char* p_start = _sp;
	while (1) 
		{
		for(i = 0; i < len; i ++) 
			{
			if(*p_start == delimiters[i]) 
				{
				p_start ++;
				break;
				}
			}

		if(i == len) 
			{
			_sp = p_start;		
			break;
			}
		}

	/**************************************************************************\
	|* return NULL if nothing left
	\**************************************************************************/
	if (*_sp == '\0')
		{
		_sp = NULL;
		return _sp;
		}

	/**************************************************************************\
	|* find the end of the substring, and replace the delimiter with null
	\**************************************************************************/
	while(*_sp != '\0') 
		{
		for(i = 0; i < len; i ++) 
			{
			if(*_sp == delimiters[i]) 
				{
				*_sp = '\0';
				break;
				}
			}

		_sp ++;
		if (i < len)
			break;
		}

	return p_start;
	}
